---
title: "Automatic Code Quality checks according to SEP guidelines"
date: "2024-12-15"
tags: ["university", "github", "CI"]
excerpt: "The set of steps needed to utilize Understand from Scitools and Simian checks within Github Actions."
---

In order to avoid either manual checks requiring each student to run the tools on their machines continuously throughout the project, or refactoring to adhere to the standards before submission, following this tutorial this process can be automated to have the checks continuously run on each pull request.

An example:
![img.png](img.png)

In this tutorial, I will guide through the steps needed to set up automatic code quality checks, on the example of our setup for frontend, but I specify each place where this template can be adjusted to your project.

# Prerequisites

- A GitHub repository for your project. 
(In case you chose to use GitLab or Bitbucket, the steps will be similar, but the tutorial is tailored to GH.)
- Understand from Scitools license
  (Single student rather than entire developing team needs to acquire it, it's reused on every run)

# Steps
To quickly summarize the steps needed to set up the checks:
1. Acquire a license for Understand from Scitools.
2. Add the license to your repository secrets.
3. Specify commands, paths, and languages to run Understand and Simian checks.
4. Create a GitHub Actions workflow file.
5. Few repo tweaks.

## Step 1 - Acquire a license for Understand from Scitools

You can acquire a free license for Understand from Scitools as a student. Follow the instructions on their website: https://scitools.com/student

## Step 2 - Add the license to your repository secrets

Once you have the license string, navigate to your GitHub repository, go to "Settings" > "Secrets and variables" > "Actions", and under "Repository secrets" add a new secret named `UNDERSTAND_LICENSE` with the license string as its value.

## Step 3 - Add python script, specify commands, paths, and languages to run Understand and Simian checks

Before creating the workflow file, we need to prepare a few things in the repository.

1. Create a folder `.github/quality_tools/` in your repository to store the necessary files.
2. Add to that folder a Python script `parse_metrics.py` to parse the metrics CSV file generated by Understand into a markdown format suitable for GitHub comments. You can download the ready-made script here: [Download parse_metrics.py](downloads/parse_metrics.py).

> Place it in `.github/quality_tools/parse_metrics.py` in your repository.

Next, we have to specify the commands for Understand to run the analysis. We create a template file named `frontend_commands.txt` in the same `.github/quality_tools/` folder.

```aiignore
create -languages Web frontend_metrics.und #TODO: Adjust the name and language
-db frontend_metrics.und #TODO: Adjust the name if you have changed it above
add frontend/src
settings -MetricShowAggregatedFileMetrics on
settings -MetricShowAggregatedClassMetrics on
settings -MetricShowCouplingAndCohesionMetrics on
settings -MetricShowInheritanceMetrics on
settings -MetricShowStatementCountMetrics on
settings -MetricCyclomatic all
settings -MetricShowDefaultSummaryMetrics on
analyze
metrics
report
```
Here to adjust to your project, you might want to change:
1. Language (e.g. `-languages C++` for C++ projects), we use 'Web' for our frontend project. List of supported languages can be found [here](https://scitools.com/support/languages/)
2. Not needed but you can also adjust the name of the database, but it should match in both places, and will have to be adjusted in templats later.

## Step 4 - Create a GitHub Actions workflow file

Either manually in a folder `.github/workflows/` or using the GitHub interface, create a new workflow file named `code_quality.yml`.
This will serve as the configuration for the CI pipeline, which we use to run checks but can be extended to do more in the future, this tutorial serves as a basis for creation just for code quality checks.


Here I provide a sample workflow file for our frontend that you can use as a starting point. You can customize it according to your project's needs.
Look at the comments (specifically those starting with `TODO`) for places where you might want to/should adjust the configuration.
```yaml
name: Code Quality Checks
on:
  workflow_dispatch: # Allows manual triggering of the workflow in GitHub UI
  push: # Triggers on push to main branch 
    branches: [main]
    paths:
      - 'frontend/**' # TODO Specify the path where changes will trigger the workflow
  pull_request: # (pull requests too) - adjust if needed
    branches: [main]
    paths:
      - 'frontend/**'
jobs:
  understand_analysis:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/maksderylo/understand-cli:latest # Premade image with the tools installed
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set UTF-8 locale
        run: |
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8

      - name: Check if license variable is set
        run: |
          if [ -z "$UNDERSTAND_LICENSE" ]; then
            echo "Understand license variable is not set!"
            exit 1
          else
            echo "Understand license variable is set."
          fi
        env:
          UNDERSTAND_LICENSE: ${{ secrets.UNDERSTAND_LICENSE }}

      - name: Register Understand license
        run: |
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8
          und -setlicensecode "$UNDERSTAND_LICENSE"
        env:
          UNDERSTAND_LICENSE: ${{ secrets.UNDERSTAND_LICENSE }}

      - name: Run Understand analysis
        run: |
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8
          und process .github/quality_tools/frontend_commands.txt # TODO Adjust the path to your commands file if needed

      - name: Install Python for metrics parsing
        run: |
          apt-get update
          apt-get install -y python3

      - name: Parse metrics CSV to markdown
        id: parse-metrics
        run: | #TODO Adjust the python file path below if needed, and the input CSV file name if you have changed db name in commands file
          python3 .github/quality_tools/parse_metrics.py --input frontend_metrics.csv --markdown > metrics_report.txt 
          # Set multi-line output
          {
            echo 'report<<EOF'
            cat metrics_report.txt
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Post metrics report comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const body = process.env.REPORT;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
        env:
          REPORT: ${{ steps.parse-metrics.outputs.report }}

      - name: Deregister Understand license
        run: |
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8
          OUTPUT=$(und -deregisterlicensecode || true)
          echo "$OUTPUT"
          echo "$OUTPUT" | grep -q "Successful"
        if: always()

      - name: Upload metrics report artifact
        uses: actions/upload-artifact@v4
        with:
          name: understand-metrics
          path: |
            frontend_metrics_html
```
